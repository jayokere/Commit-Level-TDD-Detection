name: Daily Apache Repo Miner

# Trigger the workflow:
# 1. On a schedule (Every day at 02:00 UTC)
# 2. Manually (allows you to click 'Run workflow' button for testing)
on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  mine-commits:
    runs-on: ubuntu-latest
    
    # Timeout to prevent infinite loops (standard is 6 hours)
    timeout-minutes: 360

    steps:
      # 1. Check out your code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Setup Python environment
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 3. Install dependencies
      - name: Install Libraries
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Run the Miner
      # CRITICAL: We run the class directly to bypass the 'while True' loop 
      # in your start_daily_scheduler() function.
      - name: Execute Miner
        env:
          # Inject secrets from GitHub Settings
          MONGODB_USER: ${{ secrets.MONGODB_USER }}
          MONGODB_PWD: ${{ secrets.MONGODB_PWD }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }} 
        run: |
          python -c "from repo_miner import Repo_miner; miner = Repo_miner(); miner.run()"